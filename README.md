# OLX Price Tracker

**OLX Price Tracker** — це веб-додаток, розроблений на Laravel, який дозволяє користувачам відстежувати зміни цін на оголошеннях OLX. Після реєстрації та авторизації користувачі можуть додавати посилання на цікаві їм оголошення. Сервіс автоматично перевіряє ціни цих оголошень за заданим розкладом (наприклад, кожні 15 хвилин). У випадку виявлення зміни ціни або назви, система надсилає сповіщення електронною поштою підписаним користувачам. Важливою особливістю є оптимізація: якщо кілька користувачів відстежують одне й те саме оголошення, його ціна парситься лише один раз, запобігаючи зайвим запитам до OLX.

---

## Схема роботи сервісу

Ось спрощена схема роботи сервісу, що ілюструє взаємодію компонентів.

```mermaid
graph TD
    A[Користувач] --> B(Веб-інтерфейс Laravel);

    B -- Реєстрація/Авторизація --> C{Аутентифікація};
    C -- Успішно --> D[Панель користувача];

    D -- Додати URL оголошення OLX --> E[Контролер Підписок];
    E -- Зберегти OlxAd (якщо новий) --> F[БД: OlxAds];
    E -- Зберегти Subscription --> G[БД: Subscriptions];
    F --> |Запит| OlxScraperService[Сервіс: OlxScraperService];

    subgraph "Background Process (Docker Container)"
        H[Docker Compose] --> I[Веб-контейнер: Apache + PHP-FPM];
        H --> J[Контейнер БД: MySQL];

        I -- Крон-завдання (кожну хв) --> L["Artisan Scheduler (php artisan schedule:run)"];
        L -- Виконує команду --> M["Artisan Command: olx:check-prices"];
        M --> F;
        M --> OlxScraperService;
        OlxScraperService -- Парсинг ціни --> N[OLX.ua];
        M -- Якщо ціна змінилась --> O[Відправка Email-повідомлення];
        O --> P["Mail Driver (напр., Mailtrap, SMTP - **Mailpit потрібно додати в docker-compose**)"];
    end

    F -- (Відношення) --> G;
    G -- (Відношення) --> Q[БД: Users];
    Q --> B;
    Q --> G;
````

**Пояснення до схеми:**

1.  **Користувач**: Взаємодіє з **Веб-інтерфейсом Laravel**.
2.  **Аутентифікація**: Користувач проходить процес **реєстрації/авторизації**.
3.  **Панель користувача**: Після успішної аутентифікації користувач отримує доступ до особистого кабінету.
4.  **Додавання URL оголошення**: З панелі користувача він додає URL оголошення OLX. Контролер обробляє запит:
    * Перевіряє, чи оголошення вже існує в таблиці `OlxAds`. Якщо ні, створює новий запис.
    * Створює запис про **підписку (Subscription)**, пов'язуючи користувача з оголошенням.
5.  **Бази даних**:
    * `OlxAds`: зберігає інформацію про оголошення (URL, поточну ціну, назву, останню перевірку).
    * `Subscriptions`: пов'язує `Users` з `OlxAds`.
    * `Users`: містить інформацію про користувачів.
6.  **Docker Compose**: Оркеструє всі сервіси у контейнерах:
    * **Веб-контейнер**: Містить Apache для веб-сервера та PHP-FPM для виконання PHP-коду.
    * **Контейнер БД**: MySQL для зберігання даних.
7.  **Крон-завдання**: Системний крон у веб-контейнері щохвилини запускає Laravel Artisan Scheduler (`php artisan schedule:run`).
8.  **Artisan Command**: Планувальник запускає команду `olx:check-prices`, яка:
    * Отримує список унікальних оголошень з `OlxAds`, на які є підписки.
    * Для кожного оголошення викликає **Сервіс: OlxScraperService**.
9.  **OlxScraperService**: Робить HTTP-запит до **OLX.ua**, парсить сторінку (спершу JSON-LD, потім HTML-селектори) для отримання ціни, валюти та назви.
10. **Оновлення та Сповіщення**: Якщо `olx:check-prices` виявляє зміну ціни або назви:
    * Оновлює запис `OlxAd` у базі даних.
    * Генерує email-повідомлення `PriceChangedNotification` для кожного підписаного користувача.
11. **Mail Driver**: Laravel буде використовувати драйвер пошти `smtp`, налаштований у `.env`, щоб надсилати листи на **Mailpit** (який виступає як локальний SMTP-сервер). Усі відправлені листи будуть доступні для перегляду та відлагодження у веб-інтерфейсі Mailpit (зазвичай за адресою `http://localhost:8026`), а не надсилатимуться на реальні поштові адреси. Листи відправляються безпосередньо (синхронно), оскільки черги не використовуються для відправки пошти.

-----

## Зміст

* [Особливості](#особливості)
* [Системні вимоги](#системні-вимоги)
* [Встановлення та запуск](#встановлення-та-запуск)
    * [Клонування репозиторію](#клонування-репозиторію)
    * [Налаштування змінних оточення](#налаштування-змінних-оточення)
    * [Запуск контейнерів](#запуск-контейнерів)
* [Використання](#використання)
    * [Веб-інтерфейс](#веб-інтерфейс)
    * [Планувальник (Crontab та Scheduler)](#планувальник-crontab-та-scheduler)
* [Основні технології](#основні-технології)
* [Структура проекту (ключові файли)](#структура-проєкту-ключові-файли)
* [Корисні команди](#корисні-команди)

-----

## Особливості

* **Аутентифікація користувачів:** Реєстрація, вхід, відновлення пароля.
* **Управління підписками:** Додавання та видалення URL-адрес OLX оголошень для відстеження.
* **Автоматичний парсинг цін:** Регулярна перевірка цін та назв оголошень OLX за розкладом.
* **Сповіщення електронною поштою:** Відправка листів користувачам при зміні ціни або назви.
* **Оптимізація парсингу:** Одне оголошення перевіряється лише один раз, навіть якщо на нього підписано кілька користувачів.
* **Dockerized:** Проєкт повністю контейнеризований для легкої розробки та деплою.

-----

## Системні вимоги

* **Docker Desktop** (для Windows/macOS) або **Docker Engine** та **Docker Compose** (для Linux).
* **Git**

-----

## Встановлення та запуск

### Клонування репозиторію

```bash
git clone https://github.com/vasylburdun/olx-price-tracker.git
cd olx-price-tracker/src - директорії src сам web-додаток
```

### Налаштування змінних оточення

Створіть файл `.env` на основі `.env.example`:

```bash
cp .env.example .env
```

Відкрийте файл `.env` та налаштуйте наступні змінні:

* **Налаштування Додатка:**

```env
  APP_NAME="OLX Price Tracker"
  APP_ENV=local
  APP_KEY= # Залишити порожнім, буде згенеровано Docker'ом
  APP_DEBUG=true
  APP_URL=http://localhost:8078
  OLX_SCRAPER_USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
  ```

* **Налаштування Бази Даних:**

```env
  DB_CONNECTION=mysql
  DB_HOST=mysql_db # Ім'я сервісу з docker-compose.yml
  DB_PORT=3306
  DB_DATABASE=olx_price_tracker
  DB_USERNAME=root
  DB_PASSWORD=root
  ```

* **Налаштування Email (Mailpit для розробки - якщо будете використовувати):**


```env
MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"
```

### Запуск контейнерів

Виконайте команду:
````bash
docker-compose up --build -d
````

Ця команда передбачає повне розгортання проєкту. І виконаютья всі команди автоматично, такі як: 

````bash
composer install              
# встановлення залежностей проєкту

php artisan migrate           
# виконання міграцій бази даних

npm install && npm run build  
# встановлення залежностей проєкту (frontend) та розгортання
````
Тому, після того, як контейнери запустяться, виконаються вище вказані команди.

## Використання

Відкрийте ваш браузер та перейдіть за адресою: `http://localhost:8078`.  
phpMyAdmin - `http://localhost:8048`.  
Інструмент для тестування електронної пошти та SMTP - `http://localhost:8026`

### Веб-інтерфейс

* **Реєстрація/Вхід:** Використовуйте стандартні маршрути `/register` та `/login` для створення облікового запису та входу.
* **Панель користувача:** Після входу ви будете перенаправлені на `/dashboard`, де зможете додавати нові оголошення для відстеження.

### Планувальник (Crontab та Scheduler)

Цей проєкт використовує систему планування завдань Laravel для автоматичного виконання регулярних операцій, таких як перевірка цін OLX. Ця система базується на взаємодії системного планувальника `Crontab` та вбудованого в Laravel `Scheduler`.

1.  **Crontab (Системний Рівень):**
 На сервері налаштовано єдине завдання `Crontab`, яке **запускається щохвилини**. Його єдине призначення — викликати команду Laravel Scheduler.
```bash
* * * * * cd /var/www/html && /usr/local/bin/php artisan schedule:run >> /var/log/cron.log 2>&1
```
Таким чином, `Crontab` сам по собі **не знає** про конкретні завдання вашого додатка (наприклад, "перевіряти ціни кожні 15 хв"). 
Він лише діє як **"тригер"**, який щохвилини запускає планувальник Laravel.

2.  **Laravel Scheduler:**
Коли `php artisan schedule:run` виконується, планувальник Laravel перевіряє розклад завдань, визначений у файлі **`bootstrap/app.php`** (у методі `withSchedule`).  

Він перевіряє **свій власний розклад**, який містить всі деталі запланованих завдань, визначених у вашому PHP-коді.

Наприклад, у `bootstrap/app.php` 
```php
->withSchedule(function (Schedule $schedule) {
    $schedule->command('olx:check-prices')->everyFifteenMinutes()->withoutOverlapping();
})
```
Laravel Scheduler, при кожному запуску (`щохвилини` від Crontab), перевіряє: "Чи настала хвилина для виконання `olx:check-prices`? (у цьому випадку - кожні 15 хвилина). Так? Тоді виконуємо. Ні? Тоді нічого не робимо до наступної хвилини".  

Ми використовуємо `->withoutOverlapping()` для цього завдання, щоб гарантувати, що новий екземпляр команди `olx:check-prices` не буде запущений, якщо попередній ще виконується.  

Ви можете перевірити список запланованих команд, виконавши:

```bash
docker exec -it olx-price-tracker-web php artisan schedule:list
```

## Основні технології

* **PHP 8.3+** (Згідно з Dockerfile)
* **Laravel 10/11+**
* **MySQL 8.0+** (База даних)
* **GuzzleHttp** (HTTP-клієнт для парсингу веб-сторінок)
* **Symfony DomCrawler** (Для парсингу HTML)
* **Docker**
* **Docker Compose**
* **phpMyAdmin** (Для керування БД - `http://localhost:8048`)
* **Mailpit** (інструмент для тестування електронної пошти та SMTP - `http://localhost:8026`)

-----

## Структура проєкту (ключові файли)

* `app/Console/Commands/CheckOlxPrices.php`: Artisan-команда для перевірки цін та відправки сповіщень.
* `app/Mail/PriceChangedNotification.php`: Mailable-клас для створення email-повідомлень про зміну ціни.
* `app/Models/OlxAd.php`: Eloquent-модель, що представляє OLX оголошення.
* `app/Models/Subscription.php`: Eloquent-модель, що пов'язує користувачів з OLX оголошеннями.
* `app/Models/User.php`: Eloquent-модель, що представляє користувача системи.
* `app/Services/OlxScraperService.php`: Сервіс, відповідальний за безпосередній парсинг OLX сторінок.
* `bootstrap/app.php`: Основний файл ініціалізації Laravel, де конфігурується планувальник.
* `config/*`: Директорія з файлами конфігурації Laravel (додатка, бази даних, пошти, черг тощо).
* `database/migrations/*`: Файли міграцій для створення структури бази даних.
* `docker/Dockerfile`: Визначення Docker-образу для веб-сервісу.
* `docker/config/start_app.sh`: Скрипт, що виконується при старті веб-контейнера для налаштування середовища (Composer, Cron, права доступу).
* `docker-compose.yml`: Файл конфігурації для визначення та запуску багатоконтейнерних Docker-додатків.
* `routes/web.php`: Файл, що містить веб-маршрути додатка (для реєстрації, входу, панелі користувача, управління підписками).
* `src/`: Коренева директорія проєкту Laravel, яка монтується в контейнер.

-----

## Корисні команди

```bash
docker exec -it olx-price-tracker-web php artisan view:clear     
# Очищає кеш скомпільованих Blade-шаблонів (views).

docker exec -it olx-price-tracker-web php artisan config:clear   
# Очищає кеш скомпільованих файлів конфігурації.

docker exec -it olx-price-tracker-web php artisan route:clear    
# Очищає кеш скомпільованих визначень маршрутів.

docker exec -it olx-price-tracker-web php artisan cache:clear    
# Очищає кеш, який використовується за замовчуванням драйвером кешу

docker exec -it olx-price-tracker-web php artisan optimize       
# Оптимізація програми шляхом кешування конфігурації, маршрутів та інших даних, що може покращити продуктивність

docker exec -it olx-price-tracker-web php artisan optimize:clear 
# Очищає різні кеші, щоб підвищити продуктивність програми
```